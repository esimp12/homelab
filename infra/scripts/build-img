#!/usr/bin/env bash

set -eux

OUT_IMG="$1"
DISK_LAYOUT="$2"

QEMU_IMG_BIN="/usr/bin/qemu-img"
QEMU_NBD_BIN="/usr/bin/qemu-nbd"

VDISK_DEVICE="/dev/nbd0"
VDISK_BOOT_DEVICE="${VDISK_DEVICE}p1"
VDISK_SWAP_DEVICE="${VDISK_DEVICE}p2"
VDISK_ROOT_DEVICE="${VDISK_DEVICE}p3"

function err() {
    echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*" >&2
}

function create_empty_virtual_disk() {
    $QEMU_IMG_BIN create -f qcow2 $OUT_IMG $1 
}

function check_nbd() {
    # check if we have a block device
    if [ ! -b $1 ]; then
        err "'${1}' is not a block device"
        exit 1
    fi
    # check if block device is not already mounted
    if [[ ! "${1}" =~ ^/dev/nbd[0-9]+$ ]]; then
        err "'${1}' is not a network block device"
        exit 1
    fi

    echo "'${1}' is a valid block device"
}

function create_nbd_socket() {
    sock=$(mktemp "/tmp/nbd.sock.XXXXXX")
    echo $sock
}

function mount_virtual_disk() {
    check_nbd $VDISK_DEVICE 

    echo "mounting '${OUT_IMG}' to '${VDISK_DEVICE}' using socket '${1}'"
    $QEMU_NBD_BIN --fork --socket=$1 --connect=$VDISK_DEVICE --format=qcow2 $OUT_IMG
}

function partition_virtual_disk() {
    check_nbd $VDISK_DEVICE

    sudo sfdisk "${VDISK_DEVICE}" < "${DISK_LAYOUT}"
}

function create_filesystems() {
    check_nbd $VDISK_DEVICE
    check_nbd $VDISK_BOOT_DEVICE
    check_nbd $VDISK_SWAP_DEVICE
    check_nbd $VDISK_ROOT_DEVICE

    mkfs.fat -F32 $VDISK_BOOT_DEVICE
    mkswap $VDISK_SWAP_DEVICE
    mkfs.ext4 $VDISK_ROOT_DEVICE
}

function mount_filesystems() {
    check_nbd $VDISK_DEVICE
    check_nbd $VDISK_BOOT_DEVICE
    check_nbd $VDISK_SWAP_DEVICE
    check_nbd $VDISK_ROOT_DEVICE

    iso=$(mktemp "/tmp/archmnt.XXXXXX")
    mount $VDISK_ROOT_DEVICE $iso
    mount --mkdir $VDISK_BOOT_DEVICE "${iso}/boot"
    swapon $VDISK_SWAP_DEVICE
    echo $iso
}


# 1. Create the virtual disk to turn into a bootable iso
create_empty_virtual_disk "25G"

# 2. Mount the virtual disk
nbd_socket=$(create_nbd_socket)
mount_virtual_disk $nbd_socket

# 3. Partition the virtual disk
partition_virtual_disk

# 4. Create filesystems for partitions
create_filesystems

# 5. Mount the filesystems
iso=$(mount_filesystems) 

# 6. Install base packages
pacstrap -K $iso \
    base \
    linux \
    grub \
    efibootmgr \
    vim \
    openssh \
    python \
    qemu-guest-agent \
    sudo \
    archlinux-keyring

# 7. Generate fstab
genfstab -U $iso >> "${iso}/etc/fstab"

# 8. Set bootloader settings
arch-chroot $iso /bin/bash -c "mkdir -p /etc/default"
echo <<EOF > "${iso}/etc/default/grub"
GRUB_TIMEOUT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_DEFAULT=0
EOF

# 9. Setup bootloader (w/ arch-chroot)
arch-chroot $iso /bin/bash -c <<EOF
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=archlinux
grub-mkconfig -o /boot/grub/grub.cfg
EOF

# 10. Set root passwd (w/ arch-chroot)
arch-chroot $iso /bin/bash -c <<EOF
echo "root:root" | chpasswd
EOF

# 11. Populate keyring (w/ arch-chroot)
arch-chroot $iso /bin/bash -c <<EOF
pacman-key --init
pacman-key --populate
EOF

# 12. Unmount the filesystems
umount -R $iso

# 13. Unmount the virtual disk
$QEMU_NBD_BIN --disconnect
